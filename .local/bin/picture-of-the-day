#!/usr/bin/env python3
"""
Executable module that sets the background and color scheme.

Executable functions:
    main: Main function that handles all the executable module behaviour.
"""

import re
import subprocess
import sys
import time
from pathlib import Path
from urllib import request, error


def main(args: list[str]):
    if "--system-start" in args:
        max_attempts = 10
    else:
        max_attempts = 1

    Main()(max_attempts)


class Main:
    """
    Set the background and color scheme based on the picture of the day.

    The image is fetched from the "Astronomy Picture of the Day" page:
    - https://apod.nasa.gov/apod/astropix.html

    Some changes to site structure or connection issues may cause problems. If
    this occurs, we set a random background and scheme colors. Otherwise the
    image is saved in ~/Pictures/Wallpapers and the background and color scheme
    are set using that picture.
    """

    _base_url = "https://apod.nasa.gov"
    _default_timeout = 10

    def __call__(self, max_attempts: int):
        """
        Executes the class main logic.

        Args:
            max_attempts: Maximum number of attempts to fetch the image URL.
        """
        image_url = None
        attempt = 1
        while attempt <= max_attempts:
            print(f"Attempt #{attempt}.")
            image_url = self._get_image_url()
            if image_url:
                print("Found image.")
                break
            time.sleep(5)
            attempt += 1

        if image_url and (
            image := self._download_image(image_url)
        ):
            destination_path = self._get_destination_path(image_url)
            self._save_image(destination_path, image)
        else:
            destination_path = None
        self._change_background(destination_path)

    def _get_image_url(self) -> str | None:
        try:
            with request.urlopen(
                f"{self._base_url}/apod/astropix.html",
                timeout=self._default_timeout,
            ) as response:
                if response.status != 200:
                    return

                html_content = response.read().decode("utf-8")
                image_match = re.search(
                    r"href=\"(?P<image>image\/\d{4}\/[^\"]+\..+)\"",
                    html_content,
                )

                if not image_match:
                    return

                image_url = image_match.groupdict()["image"]
                return image_url

        except error.URLError:
            return

    def _get_destination_path(self, image_url: str) -> Path:
        image_name = image_url.split("/")[-1]
        destination_path = Path.home() / "Pictures" / "Wallpapers" / image_name
        return destination_path

    def _download_image(self, image_url: str) -> bytes | None:
        try:
            with request.urlopen(
                f"{self._base_url}/{image_url}",
                timeout=self._default_timeout,
            ) as response:
                image = response.read()
                return image
        except error.URLError:
            return

    def _save_image(self, destination_path: Path, image: bytes):
        destination_path.parent.mkdir(parents=True, exist_ok=True)
        with open(destination_path, "wb") as file:
            file.write(image)

    def _change_background(self, destination_path: Path | None):
        # The "change-background" is an external executable that updates the
        # background and color scheme.
        subprocess_args = ["change-background"]
        if destination_path:
            subprocess_args.append(str(destination_path))
        subprocess.call(subprocess_args)


if __name__ == "__main__":
    main(sys.argv[1:])
