#!/usr/bin/env python
"""
An executable module that's set the background and color scheme

Functions:
    main
"""
import re
import requests
import shlex, subprocess
from pathlib import Path
from typing import NoReturn


def main() -> NoReturn:
    """
    Set the background and the color scheme based on the APD* site

    * APD: Astronomy Picture of the Day
    APD site: https://apod.nasa.gov/apod/astropix.html

    Some changes to site structure or connection problems may generate
    exceptions. If this occurs, we set a random background and schema colors.
    The image is saved in ~/Pictures/Wallpapers folder.
    """
    nasa_base_url = "https://apod.nasa.gov"
    try:
        web_response = requests.get(f"{nasa_base_url}/apod/astropix.html")

        # Download and save the picture of the day
        image_match = re.search(r"href=\"(?P<image>image\/\d{4}\/[^\"]*.jpg)\"", web_response.text)
        image_path = image_match.groupdict()['image']
        image = requests.get(f"{nasa_base_url}/{image_path}")
        image_name = image_path.split("/")[-1]
        destination_path = Path.home() / "Pictures" / "Wallpapers" / image_name
        with open(destination_path, "wb") as file:
            file.write(image.content)

        # Add EXIF description tag to the image
        description_match = re.search(r"<center>\s*<b>(?P<description>.*)</b>", web_response.text)
        description = description_match.groups()[0].strip()
        subprocess.call(shlex.split(f"exiftool -overwrite_original -Description=\"{description}\" {destination_path}"))

        # Set the new wallpaper and color scheme
        subprocess.call(['change-background', destination_path])

    except Exception:
        # Set a random wallpaper and color scheme
        subprocess.call(['change-background'])


if __name__ == "__main__":
    main()
